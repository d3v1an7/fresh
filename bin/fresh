#!/bin/bash

source_utils() {
  util_source="${HOME}/.fresh/bin/utils"
  if [ ! -f "${util_source}" ]; then
    source /dev/stdin <<< "$(curl --insecure --location --silent https://github.com/d3v1an7/macos-fresh/raw/master/bin/utils)"
  else
    source "${util_source}"
  fi
}

create_brewfile() {
  thing="${HOME}/.fresh/Brewfile"
  yq -r \
    '.brew | to_entries[] |
    if .key == "mas" then
      (.value[]) as $item | "\(.key) \"\($item.name)\", id: \($item.id)"
    else
      "\(.key) \"\(.value[])\""
    end' "${config}" \
  > "${thing}"
  utils_print_status "pass" "${thing}"
}

create_mackupcfg() {
  thing="${HOME}/.mackup.cfg"
  yq -r \
    '.mackup | to_entries[] |
    if .key == "storage" then
      (.value | to_entries[]) as $item | "[\(.key)]","\($item.key)=\($item.value)"
    else
      "[\(.key)]","\(.value[])"
    end' "${config}" \
  > "${thing}"
  utils_print_status "pass" "${thing}"
}

run_brew_bundle_install() {
  thing="brew bundle install"
  utils_print_heading "Run ${thing}"
  brew bundle install --file=~/.fresh/Brewfile
  echo
  utils_print_status "pass" "${thing}"
}

open_dropbox() {
  thing="Dropbox setup"
  utils_print_heading "Run ${thing}"
  open -a "Dropbox"
  echo "Dropbox will open shortly, please complete the setup and first sync before proceeding."
  echo
  read -n 1 -s -p "When Dropbox has finished sync, press any key to continue..."
  echo
  utils_print_status "pass" "${thing}"
}

run_mackup_restore() {
  thing="brew mackup restore"
  utils_print_heading "Run ${thing}"
  mackup restore
  echo
  utils_print_status "pass" "${thing}"
}

update_defaults() {
  thing="system.defaults"
  utils_defaults "bork" ".system.defaults" | tee -a "${log}"
  utils_print_status "pass" "${thing}"
}

update_defaults_global() {
  thing="system.defaults"
  utils_defaults "global" ".system.defaults_global" | tee -a "${log}"
  utils_print_status "pass" "${thing}"
}

update_defaults_arrays() {
  thing="system.defaults_arrays"
  utils_defaults "defaults" ".system.defaults_arrays" | tee -a "${log}"
  utils_print_status "pass" "${thing}"
}

update_defaults_plistbuddy() {
  thing="system.defaults_plistbuddy"
  utils_defaults "plistbuddy" ".system.defaults_plistbuddy" | tee -a "${log}"
  utils_print_status "pass" "${thing}"
}

misc_install_font() {
  thing="System font"
  utils_print_heading "Install ${thing}"
  query=$(yq -r '.misc.font' ~/.fresh/config.yaml)
  font_name=$(echo $query | jq -r '.name')
  font_download=$(echo $query | jq -r '.download')
  font_path=$(echo $query | jq -r '.path')
  if [ ! -f "${HOME}/Library/Fonts/${font_name}" ]; then
    curl --location --silent --output /tmp/font.zip "${font_download}"
    unzip -q -o /tmp/font.zip -d /tmp
    cp -R "/tmp/${font_path}/." "${HOME}/Library/Fonts"
  fi
  utils_print_status "pass" "${thing} installed"
}

misc_screensaver_name() {
  thing="Set screensaver name"
  query=$(yq -r '.misc.screensaver.name' ~/.fresh/config.yaml)
  if [ "${query}" != "null" ]; then
    utils_print_heading "${thing}"
    utils_defaults "plistbuddy" ".misc.screensaver.name.defaults" | tee -a "${log}"
    utils_print_status "pass" "${thing}"
  fi
}

misc_screensaver_idle_time() {
  thing="Set screensaver idle time"
  query=$(yq -r '.misc.screensaver.idle_time' ~/.fresh/config.yaml)
  if [ "${query}" != "null" ]; then
    utils_print_heading "${thing}"
    utils_defaults "plistbuddy" ".misc.screensaver.idle_time.defaults" | tee -a "${log}"
    utils_print_status "pass" "${thing}"
  fi
}

misc_chrome_set_as_default() {
  thing="Set Chrome as default"
  query=$(yq -r '.misc.chrome.default' ~/.fresh/config.yaml)
  if [[ "${query}" == "true" ]]; then
    utils_print_heading "${thing}"
    open --new -a 'Google Chrome' --args --make-default-browser
    utils_print_status "pass" "${thing}"
  fi
}

misc_chrome_preferences() {
  thing="Set Chrome preferences"
  utils_print_heading "${thing}"
  utils_defaults "bork" ".misc.chrome.defaults" | tee -a "${log}"
  echo
  utils_print_status "pass" "${thing}"
}

misc_iterm2_import_style() {
  thing="Import iTerm2 style"
  query=$(yq -r '.misc.iterm2.import_style' ~/.fresh/config.yaml)
  if [[ "${query}" == "true" ]]; then
    utils_print_heading "${thing}"
    style_src="${HOME}/.fresh/misc/iTerm2/style.json"
    style_dest="${HOME}/Library/Application Support/iTerm2/DynamicProfiles/style.json"
    if [ ! -f "${style_dest}" ]; then
      cp "${style_src}" "${style_dest}"
    fi
    if [ ! -f "${HOME}/Library/Preferences/com.googlecode.iTerm2.plist" ]; then
      open -a iTerm && sleep 2 && killall iTerm2
    fi
    defaults write com.googlecode.iterm2 "Default Bookmark Guid" -string "ba19744f-6af3-434d-aaa6-0a48e0969958" | tee -a "${log}"
    utils_print_status "pass" "${thing}"
  fi
}

misc_iterm2_shell_integration() {
  thing="Enable iTerm2 shell integration"
  query=$(yq -r '.misc.iterm2.shell_integration' ~/.fresh/config.yaml)
  if [[ "${query}" == "true" ]]; then
    utils_print_heading "${thing}"
    curl --location --silent https://iterm2.com/misc/install_shell_integration.sh | bash
    echo
    utils_print_status "pass" "${thing}"
  fi
}

misc_iterm2_preferences() {
  thing="Set iTerm2 preferences"
  utils_print_heading "${thing}"
  utils_defaults "bork" ".misc.iterm2.defaults" | tee -a "${log}"
  echo
  utils_print_status "pass" "${thing}"
}

clear_preference_cache() {
  thing="Clear preference cache"
  utils_print_heading "${thing}"
  array=(
    Finder
    Dock
    SystemUIServer
    cfprefsd
  )
  for item in "${array[@]}"; do
    killall "${item}"
  done
  utils_print_status "pass" "${thing}"
}

see_you_space_cowboy(){
  echo "See you, Space Cowboy"
  # say --voice=fred --rate=250 "See you, Space Cowboy"
}
source_utils
utils_sudo_keep_alive
utils_print_heading "Creating config files"
create_brewfile
create_mackupcfg
run_brew_bundle_install
open_dropbox
run_mackup_restore
utils_print_heading "Updating system defaults"
osascript -e 'tell application "System Preferences" to quit'
update_defaults
update_defaults_global
update_defaults_arrays
update_defaults_plistbuddy
misc_install_font
misc_screensaver_name
misc_screensaver_idle_time
misc_chrome_set_as_default
misc_chrome_preferences
misc_iterm2_import_style
misc_iterm2_shell_integration
misc_iterm2_preferences
clear_preference_cache
see_you_space_cowboy
utils_print_heading "Fresh complete!"
