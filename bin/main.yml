---
- name: check if iterm settings exists
  stat:
    path: "{{ home }}/Library/Preferences/com.googlecode.iTerm2.plist"
  register: iterm_settings

- name: check if style.json exists
  stat:
    path: "{{ home }}/Library/Application Support/iTerm2/DynamicProfiles/style.json"
  register: iterm_style

- name: open iterm to init preference files
  shell: open -a iTerm && sleep 2 && killall iTerm2
  when: iterm_settings.stat.exists == false

- name: copy style.json to dynamic profile folder
  copy:
    src: style.json
    dest: "{{ home }}/Library/Application Support/iTerm2/DynamicProfiles/style.json"
  when: iterm_style.stat.exists == false

- name: write iterm defaults
  osx_defaults:
    domain: com.googlecode.iterm2
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  with_items:
    # Don’t display the annoying prompt when quitting iTerm
    - { key: "PromptOnQuit", type: "bool", value: "false" }
    # Don’t display the annoying update prompt
    - { key: "SUEnableAutomaticChecks", type: "bool", value: "false" }
    # Set default profile (GUID found in iterm/files/style.json)
    - { key: "Default Bookmark Guid", type: "string", value: "ba19744f-6af3-434d-aaa6-0a48e0969958" }

# - name: install shell integration
#   shell: curl -L https://iterm2.com/misc/install_shell_integration.sh | bash





---
- name: check if font exists
  stat:
    path: "{{ home }}/Library/Fonts/SourceCodePro-Regular.otf"
  register: font

# Using `get_url` and `shell` unzip for now, as there seems to be issues with `unarchive` on 2.1.1.0
# "Unexpected error when accessing exploded file: [Errno 2] No such file or directory: '/tmp/source-code-pro-release/'"
- name: download font
  get_url:
    url: https://github.com/adobe-fonts/source-code-pro/archive/release.zip
    dest: /tmp/source-code-pro-release.zip
  when: font.stat.exists == false

- name: unzip font
  shell: unzip -o /tmp/source-code-pro-release.zip -d /tmp
  args:
    creates: /tmp/source-code-pro-release
  when: font.stat.exists == false

- name: copy fonts to library
  synchronize:
    src: /tmp/source-code-pro-release/OTF/
    dest: "{{ home }}/Library/Fonts"
  when: font.stat.exists == false




---
- name: set google chrome as default browser
  shell: "open --new -a 'Google Chrome' --args --make-default-browser"

- name: write google chrome defaults
  osx_defaults:
    domain: com.google.Chrome
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  with_items:
    # Disable the all too sensitive backswipe on trackpads and Magic Mouse
    - { key: "AppleEnableSwipeNavigateWithScrolls", type: "bool", value: "false" } # Default: key absent
    - { key: "AppleEnableMouseSwipeNavigateWithScrolls", type: "bool", value: "false" } # Default: key absent




---
- name: check if atom theme exists
  stat:
    path: "{{ home }}/.atom/packages/base16-eighties-one-dark"
  register: atom_theme

# Using `get_url` and `shell` unzip for now, as there seems to be issues with `unarchive` on 2.1.1.0
- name: download atom theme
  get_url:
    url: https://github.com/robneu/base16-eighties-one-dark/archive/master.zip
    dest: /tmp/base16-eighties-one-dark-master.zip
  when: atom_theme.stat.exists == false

- name: unzip atom theme
  shell: unzip -o /tmp/base16-eighties-one-dark-master.zip -d /tmp
  args:
    creates: /tmp/base16-eighties-one-dark-master
  when: atom_theme.stat.exists == false

- name: ensure atom preference dir exists
  file:
    path: "{{ home }}/.atom/packages/"
    recurse: yes
    state: directory

- name: copy theme to atom
  become: yes
  synchronize:
    src: /tmp/base16-eighties-one-dark-master/
    dest: "{{ home }}/.atom/packages/base16-eighties-one-dark/"
  when: atom_theme.stat.exists == false

- name: overwite atom config
  copy:
    content: |
      "*":
        welcome:
          showOnStartup: false
        editor:
          invisibles: {}
          fontFamily: "Source Code Pro"
          fontSize: 13
          showInvisibles: true
          showIndentGuide: true
          tabType: "soft"
        core:
          themes: [
            "one-dark-ui"
            "base16-eighties-one-dark"
          ]
    dest: "~/.atom/config.cson"
