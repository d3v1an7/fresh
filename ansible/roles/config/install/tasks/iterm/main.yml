---
- name: check if iterm theme exists
  stat:
    path: "/tmp/base16-eighties.dark.256.itermcolors"
  register: iterm_theme

- name: check if iterm settings exists
  stat:
    path: "{{ home }}/Library/Preferences/com.googlecode.iTerm2.plist"
  register: iterm_settings

- name: download iterm theme
  get_url:
    validate_certs: False
    url: https://raw.githubusercontent.com/chriskempson/base16-iterm2/master/base16-eighties.dark.256.itermcolors
    dest: /tmp
  when: iterm_theme.stat.exists == false

- name: open iterm to init preference files
  shell: open -a iTerm && sleep 2 && killall iTerm
  when: iterm_settings.stat.exists == false

- name: write iterm defaults
  osx_defaults:
    domain: com.googlecode.iterm2
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  with_items:
    # Don’t display the annoying prompt when quitting iTerm
    - { key: "PromptOnQuit", type: "bool", value: "false" }
    # Don’t display the annoying update prompt
    - { key: "SUEnableAutomaticChecks", type: "bool", value: "false" }

- name: open iterm again to complete preference files
  # We can close nicely without prompt now
  shell: open -a iTerm && sleep 2 && osascript -e 'quit app "iTerm"'
  when: iterm_settings.stat.exists == false

- name: wait for iterm preference file to populate
  wait_for:
    path: "{{ home }}/Library/Preferences/com.googlecode.iTerm2.plist"
    search_regex: "New Bookmarks"

- name: write iterm defaults (plistbuddy)
  shell: /usr/libexec/PlistBuddy -c "{{ item }}" "{{ home }}/Library/Preferences/com.googlecode.iTerm2.plist"
  with_items:
    # Set font
    - "Set 'New Bookmarks':0:'Normal Font' 'SourceCodePro-Regular 13'"
    # Enable forever scroll
    - "Set 'New Bookmarks':0:'Unlimited Scrollback' true"
    # Remove default colour settings
    - "Delete 'New Bookmarks':0:'Ansi 0 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 1 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 2 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 3 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 4 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 5 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 6 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 7 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 8 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 9 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 10 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 11 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 12 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 13 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 14 Color'"
    - "Delete 'New Bookmarks':0:'Ansi 15 Color'"
    - "Delete 'New Bookmarks':0:'Background Color'"
    - "Delete 'New Bookmarks':0:'Bold Color'"
    - "Delete 'New Bookmarks':0:'Cursor Color'"
    - "Delete 'New Bookmarks':0:'Cursor Text Color'"
    - "Delete 'New Bookmarks':0:'Foreground Color'"
    - "Delete 'New Bookmarks':0:'Selected Text Color'"
    - "Delete 'New Bookmarks':0:'Selection Color'"
    # Merge new colour settings from file
    - "Merge /tmp/base16-eighties.dark.256.itermcolors 'New Bookmarks':0"
