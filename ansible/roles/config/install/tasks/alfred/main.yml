---
- name: include licence
  include_vars: "{{ playbook_dir }}/roles/config/install/tasks/alfred/vars/licence.yml"
  when: vault_pass.stat.exists

- name: check if alfred settings exists
  stat:
    path: "{{ home }}/Library/Application Support/Alfred 3/Alfred.alfredpreferences"
  register: alfred_settings

- name: open alfred to init preference files
  shell: open -a "Alfred 3" && sleep 2 && killall "Alfred 3"
  when: alfred_settings.stat.exists == false

- name: write alfred defaults
  osx_defaults:
    domain: "{{ home }}/Library/Application Support/Alfred 3/license.plist"
    key: "{{ item.key }}"
    type: "{{ item.type }}"
    value: "{{ item.value }}"
  with_items:
    # Add licence
    - { key: "email", type: "string", value: "{{ licence_alfred_email | default }}" }
    - { key: "code", type: "string", value: "{{ licence_alfred_code | default }}" }
  when: vault_pass.stat.exists and alfred_settings.stat.exists

# Doesn't exist on fresh installs #!# fix later
# - name: find alfred preferences localhash
#   find:
#     paths: "{{ home }}/Library/Application Support/Alfred 3/Alfred.alfredpreferences/preferences/local"
#     file_type: directory
#     patterns: "[0-9a-f]{40}"
#     use_regex: True
#   register: alfred_preferences_localhash
#
# - name: write alfred defaults (plistbuddy)
#   shell: /usr/libexec/PlistBuddy -c "{{ item.command }}" "{{ alfred_preferences_localhash.files[0].path }}/{{ item.file }}"
#   with_items:
#     # Enable clipboard history
#     - { command: "Add enabled bool true", file: "features/clipboard/prefs.plist" }
#     # Set hotkey to command+space
#     - { command: "Set default:key 49", file: "hotkey/prefs.plist" }
#     - { command: "Set default:mod 1048576", file: "hotkey/prefs.plist" }
#     - { command: "Set default:string Space", file: "hotkey/prefs.plist" }
#   register: alfred_plistbuddy
#   failed_when: "alfred_plistbuddy.stderr and 'Entry Already Exists' not in alfred_plistbuddy.stderr"
